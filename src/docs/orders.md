#Алгоритм и особенности исполнения торговых поручений

##Выставление торговых поручений

###Лимитное торговое поручение
Чтобы не тратить время на постоянное отслеживание котировок на бирже, вы можете выставить так называемую лимитную заявку — это указание брокеру, какую бумагу или валюту, сколько лотов и по какой цене вы хотите купить или продать.

Биржа ограничивает цену, которую можно указать в лимитной заявке, крайними предложениями в биржевом стакане (параметры limitUp и limitDown).

**Обратите внимание, что в некоторых случаях может возникнуть ситуация, когда limitDown > limitUp. Это нормально, т.к. limitUp ограничивает на покупку, а limitDown - на продажу, потому ситуация limitDown > limitUp не является аномальной.**

Выставить лимитное торговое поручение (заявку) можно при помощи метода OpenAPI [Создание лимитной заявки](https://tinkoff.github.io/invest-openapi/swagger-ui/#/orders/post_orders_limit_order)


###Рыночное торговое поручение
Это заявка на покупку или продажу активов по той цене, что есть на бирже в данный момент. У нее есть важная 
особенность.
При исполнении рыночной заявки может оказаться, что в данный момент на бирже по текущей цене 
торгуется меньше лотов, чем вы указали, при этом другие лоты есть, но их цена отличается в негативную для 
вас сторону.
В этом случае брокер купит имеющееся количество лотов по текущей цене, а оставшуюся часть заявки будет 
покупать по следующей по списку цене. Если на бирже низкая ликвидность — например, торги рано утром или до 
открытия американской биржи, — то оставшаяся часть заявки может быть исполнена по невыгодной для вас цене. 
Проверить текущую ликвидность можно в 
[биржевом стакане.](https://tinkoff.github.io/invest-openapi/swagger-ui/#/market/get_market_orderbook)

Выставить рыночное торговое поручение (заявку) можно при помощи метода OpenAPI [Создание рыночной заявки](https://tinkoff.github.io/invest-openapi/swagger-ui/#/orders/post_orders_market_order)

##Отмена торговых поручений
В процессе торговли может возникнуть необходимость отменить невыполненную или частично выполненную заявку. Для этого используется метод OpenAPI [Отмена заявки](https://tinkoff.github.io/invest-openapi/swagger-ui/#/orders/post_orders_cancel)

##Стоп-заявки
В данный момент OpenAPI **не поддерживает** работу со стоп-заявками (take-profit, stop-loss и т.п.)

##Особенности исполнения заявок на Санкт-Петербургской бирже
Все операции с иностранными ценными бумагами в [Тинькофф Инвестиции](https://www.tinkoff.ru/invest/) производятся на Санкт-Петербургской бирже, которая имеет ряд особенностей исполнения заявок.

У данной биржи есть два пула ликвидности — США и собственный. Пул США подключается в 14:30 Мск по летнему 
американскому времени. Ранее выставленные ордера остаются на СПБ. В момент выставления торгового поручения 
механизм [best execution](https://nprts.ru/ru/projects/bestexecution/) проверяет, в каком пуле лучше условия 
и выставляет заявку туда. После выставления заявка уже не переносится между пулами, поэтому может быть ситуация, 
что пул, в котором выставлена заявка не достиг лимитной цены, а в другом пуле нужная цена достигалась. 

Вся же биржевая информация (свечи, стаканы) транслируются агрегируя информация со всех пулов ликвидности.

Исходя из этого может случиться ситуация, когда выставленное торговое поручение не исполняется, 
хотя имеются подходящие в стакане цены/предложения. В данных ситуациях команда OpenAPI рекомендует перевыставлять 
(отменить и выставить заново) заявки, чтобы механизм выбора пула ликвидности разместил заявку в более подходящем пуле.

Неисполненные заявки могут сниматься в разное время по описанным выше причинам. Время жизни заявки в каждом пуле ликвидности
соответствует [времени работы](https://spbexchange.ru/ru/stocks/inostrannye/raspisanie/) соответствующей сессии пула.


